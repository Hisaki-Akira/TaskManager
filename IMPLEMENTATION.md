# 実装詳細

## コンポーネント構成

### 1. App.tsx - メインアプリケーション

メインコンポーネントで、アプリケーション全体の状態を管理します。

**状態管理:**
- `tasks`: タスクの配列
- `viewMode`: 表示期間（week/month/quarter）
- `isModalOpen`: モーダルの開閉状態
- `prefillUserId`: プリフィルするユーザーID
- `prefillDate`: プリフィルする日付
- `selectedTask`: 選択されたタスク

**主な機能:**
- タスクの追加（`handleAddTask`）
- タスクのクリック処理（`handleTaskClick`）
- 空白セルのクリック処理（`handleEmptyClick`）
- タスクの削除（`handleDeleteTask`）
- 表示期間の切り替え

### 2. TimelineHeader.tsx - 日付軸ヘッダー

タイムラインの上部に表示される日付ヘッダー。

**機能:**
- 日付の表示（M/D形式）
- 曜日の表示（日本語）
- 今日のハイライト（黄色背景）
- 週末の色分け（グレーテキスト）
- sticky固定でスクロール時も常に表示

**スタイリング:**
- ダークモード（#111827背景）
- 各日付セル: 60px幅

### 3. UserRow.tsx - ユーザー行

各ユーザーの情報とタイムラインを表示。

**機能:**
- ユーザー情報の表示
  - 名前とカラーインジケーター
  - 稼働率（色分け）
  - タスク数
  - 重複警告（⚠️）
- タスクブロックの配置
  - 重複タスクの縦積み表示
  - 複数レーンの自動計算
- 空白セルのクリックハンドリング

**タスク配置アルゴリズム:**
1. タスクを開始日でソート
2. 各タスクを順番に処理
3. 既存のレーンと重複しない場合、そのレーンに配置
4. 重複する場合、新しいレーンを作成
5. 行の高さを動的に調整

**稼働率の色分け:**
```javascript
0-50%  : #10b981 (緑 - 余裕あり)
51-80% : #f59e0b (黄 - 適正)
81-100%: #ef4444 (赤 - 過負荷)
```

### 4. TaskBlock.tsx - タスクブロック

個々のタスクを視覚化するコンポーネント。

**機能:**
- タスク名の表示
- ホバー時のアニメーション
  - 上に2px移動
  - シャドウ強調
- ツールチップの表示
  - タスク名
  - 開始日・終了日

**スタイリング:**
- 高さ: 32px
- パディング: 4px 8px
- 角丸: 4px
- カラー: ユーザーの色またはタスクの色

### 5. AddTaskModal.tsx - タスク追加モーダル

新しいタスクを追加するためのモーダルダイアログ。

**機能:**
- タスク名の入力
- 担当者の選択（ドロップダウン）
- 開始日の入力（date picker）
- 終了日の入力（date picker）
- プリフィル対応
  - ユーザー行クリック時: 担当者がプリフィル
  - 日付セルクリック時: 開始日・終了日がプリフィル
- バリデーション（必須項目チェック）

## ユーティリティ関数

### dateUtils.ts

**`getDateRange(startDate, days)`**
- 指定された開始日から指定日数分の日付配列を生成
- 戻り値: Date[]

**`formatDate(date, format)`**
- 日付をフォーマット
- format='short': M/D形式
- format='long': YYYY-MM-DD形式

**`getDaysBetween(start, end)`**
- 2つの日付文字列（YYYY-MM-DD）間の日数を計算
- 開始日・終了日を含む（+1日）

**`isToday(date)`**
- 指定された日付が今日かどうかを判定

**`isWeekend(date)`**
- 指定された日付が週末（土日）かどうかを判定

**`getWeekday(date)`**
- 曜日を日本語で取得（日月火水木金土）

### workloadUtils.ts

**`calculateWorkload(userId, tasks, startDate, endDate)`**
- 指定期間におけるユーザーの稼働率を計算
- 戻り値: UserWorkload
  - utilization: 稼働率（0-100%）
  - taskCount: タスク数
  - hasOverlap: 重複の有無

**計算ロジック:**
1. ユーザーのタスクをフィルタ
2. 各タスクの期間を計算
3. 期間が重複する場合も合計（意図的）
4. 総稼働日数 / 総日数 * 100
5. 最大100%でキャップ

**`detectOverlap(tasks)`**
- タスク配列内で重複があるかを検出
- 戻り値: boolean

**`getTaskPosition(task, startDate, dayWidth)`**
- タスクの表示位置と幅を計算
- 戻り値: { left: number, width: number }
- left: タイムライン開始からのピクセル数
- width: タスク期間に応じたピクセル数

## データフロー

```
App (状態管理)
├── tasks (state)
├── viewMode (state)
└── handlers
    ├── handleAddTask
    ├── handleTaskClick
    ├── handleEmptyClick
    └── handleDeleteTask

↓ Props

TimelineHeader
└── 日付配列を受け取り表示

UserRow (各ユーザーごと)
├── user data
├── tasks (フィルタされていない全タスク)
├── workload (計算済み)
└── handlers
    ├── onTaskClick
    └── onEmptyClick
    
    ↓ 内部処理
    
    TaskBlock (各タスクごと)
    ├── task data
    ├── position (計算済み)
    └── onClick handler

AddTaskModal
├── isOpen (state)
├── prefill data
└── onAdd handler
```

## UI/UXの工夫

### 1. 色による視覚的フィードバック

- **稼働率**: 緑→黄→赤のグラデーション
- **警告**: ⚠️絵文字で直感的に警告
- **今日**: 黄色ハイライトで現在位置を明示
- **週末**: グレー表示で平日と区別

### 2. インタラクティブな操作

- **ホバー効果**: タスクブロックが浮き上がる
- **ツールチップ**: 詳細情報を表示
- **クリック操作**: 
  - タスク → 詳細表示
  - 空白 → タスク追加（プリフィル）

### 3. 情報の階層化

- **一次情報**: 稼働率、タスク数（常に表示）
- **二次情報**: タスク詳細（ホバー/クリック）
- **三次情報**: 編集・削除（モーダル内）

### 4. レスポンシブなレイアウト

- **固定サイドバー**: ユーザー情報は常に表示
- **横スクロール**: 長期間の表示にも対応
- **sticky ヘッダー**: 日付を常に確認可能

## パフォーマンス最適化

### 実装されている最適化

1. **コンポーネントの最小化**
   - 必要最小限の再レンダリング
   - React.memo の使用（必要に応じて）

2. **計算の効率化**
   - workloadは事前計算してpropsで渡す
   - position計算はレンダリング時のみ

### さらなる最適化の余地

1. **仮想化スクロール**
   - ユーザー数が多い場合
   - react-window などのライブラリ

2. **メモ化**
   - useMemo でworkload計算
   - useCallback でハンドラー

3. **遅延ロード**
   - タスクデータの分割読み込み

## テスト戦略

### ユニットテスト

**dateUtils.ts**
- 日付範囲生成の正確性
- フォーマット処理の正確性
- 日数計算の正確性

**workloadUtils.ts**
- 稼働率計算の正確性
- 重複検出の正確性
- 位置計算の正確性

### コンポーネントテスト

**UserRow**
- タスクの正しい配置
- 重複タスクの縦積み
- クリックイベントの発火

**TaskBlock**
- ホバー時のツールチップ表示
- クリックイベントの伝播

**AddTaskModal**
- フォーム入力のバリデーション
- プリフィルの動作
- タスク追加の実行

### 統合テスト

**App**
- タスクの追加・削除
- 表示期間の切り替え
- モーダルの開閉

## 拡張性

### 簡単に追加できる機能

1. **タスクの編集**
   - TaskDetailモーダルに編集フォーム追加

2. **タスクのドラッグ&ドロップ**
   - react-beautiful-dnd などのライブラリ
   - startDate/endDateの更新

3. **フィルタリング**
   - ユーザーフィルター
   - タスク名検索
   - 期間フィルター

4. **エクスポート**
   - CSV出力
   - カレンダー形式

5. **データ永続化**
   - LocalStorage
   - バックエンドAPI連携

### アーキテクチャの拡張

1. **状態管理ライブラリ**
   - Redux / Zustand / Jotai
   - 複雑な状態管理が必要な場合

2. **ルーティング**
   - React Router
   - 複数ページへの拡張

3. **API統合**
   - REST API / GraphQL
   - リアルタイム更新（WebSocket）

4. **認証**
   - ユーザーログイン
   - 権限管理

## デプロイ

### 静的ホスティング

**GitHub Pages**
```bash
# index.htmlをgh-pagesブランチにデプロイ
git checkout -b gh-pages
git add index.html
git commit -m "Deploy"
git push origin gh-pages
```

**Netlify / Vercel**
- ドラッグ&ドロップでデプロイ
- 自動ビルド設定

### ビルドツールを使う場合

**Vite**
```bash
npm run build
npm run preview
```

**デプロイ先:**
- Vercel
- Netlify  
- AWS S3 + CloudFront
- Firebase Hosting

## トラブルシューティング

### CDNが読み込めない

**原因:** ネットワーク制限、CORS問題
**解決:** ローカルにReactをダウンロードして使用

### タスクが表示されない

**原因:** 日付フォーマットの問題
**解決:** YYYY-MM-DD形式を使用しているか確認

### 稼働率が100%を超える

**原因:** タスクの重複（意図的な動作）
**解決:** 重複検出とワーニング表示で対応済み

### レイアウトが崩れる

**原因:** ブラウザの互換性
**解決:** モダンブラウザ（Chrome, Firefox, Safari, Edge）を使用

## まとめ

このリソーススケジューラーは、以下の原則に基づいて設計されています：

1. **シンプルさ** - 複雑な機能よりも使いやすさを優先
2. **視覚性** - 色とレイアウトで直感的に理解可能
3. **拡張性** - 必要に応じて機能追加が容易
4. **パフォーマンス** - 最小限の依存関係で高速動作

人間の判断を助けるツールとして、必要な情報を必要なタイミングで提供することを目指しています。
